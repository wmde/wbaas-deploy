# When listing a BUNCH of stuff in a map, this needed bumping..
map_hash_bucket_size 128;

# For current deployement this is "app", in the future this can be the version..
#SELECT CONCAT("\"", domain, "\""), "\"app\";"
#FROM `wikis`
#WHERE deleted_at IS NULL
#LIMIT 900
map $host $mwversion {
        default "139-app";
        "dancing-digital.wikibase.cloud" "138-app";
        "stolen-relations.wikibase.cloud" "138-app";
        "yoreanaheim.wikibase.cloud" "138-app";
        "itunderpress.wikibase.cloud" "138-app";
        "lcpindex.wikibase.cloud" "138-app";
        "pbsandbox.wikibase.cloud" "138-app";
        "manuscripts.wikibase.cloud" "138-app";
        "linked-lions.wikibase.cloud" "138-app";
        "ascltestwikibase.wikibase.cloud" "138-app";
        "avery-index-to-architectural-periodicals.wikibase.cloud" "138-app";
        "ckg-exploratory-search.wikibase.cloud" "138-app";
        "ubcfumetti.wikibase.cloud" "138-app";
        "north-carolina-gazetteer.wikibase.cloud" "138-app";
        "mood-chat.wikibase.cloud" "138-app";
        "daieuxetdailleurs.wikibase.cloud" "138-app";
        "graffiti.wikibase.cloud" "138-app";
        "denkyemx.wikibase.cloud" "138-app";
        "nttdata.wikibase.cloud" "138-app";
        "immaterieel-erfgoed.wikibase.cloud" "138-app";
        "iast-metadata-test.wikibase.cloud" "138-app";
        "npl-aib.wikibase.cloud" "138-app";
        "gotland.wikibase.cloud" "138-app";
        "glacierwatch.wikibase.cloud" "138-app";
        "valeries-galleries.wikibase.cloud" "138-app";
        "berlinked.wikibase.cloud" "138-app";
        "stream.bootsa.net" "138-app";
        "bcuf-test.wikibase.cloud" "138-app";
        "living-science.wikibase.cloud" "138-app";
        "anthrograph.io" "138-app";
        "metabase.wikibase.cloud" "138-app";
        "textdiveglobal.wikibase.cloud" "138-app";
        "pokedata.wikibase.cloud" "138-app";
        "fmtest.wikibase.cloud" "138-app";
        "fmtest2.wikibase.cloud" "138-app";
        "anachroniques.wikibase.cloud" "138-app";
        "widaba.wikibase.cloud" "138-app";
        "cooperatives.wikibase.cloud" "138-app";
        "nordhausen.wikibase.cloud" "138-app";
        "bibliography-lv.wikibase.cloud" "138-app";
        "riga-literata.wikibase.cloud" "138-app";
        "glambase.wikibase.cloud" "138-app";
        "datenbank.nordhausen.org" "138-app";
        "paleo-data.wikibase.cloud" "138-app";
        "mcarchives.wikibase.cloud" "138-app";
        "fomudemo.wikibase.cloud" "138-app";
        "pbsandbox2.wikibase.cloud" "138-app";
        "alicetest.wikibase.cloud" "138-app";
        "oswald.wikibase.cloud" "138-app";
        "prosop-wiki.wikibase.cloud" "138-app";
        "diglearning.wikibase.cloud" "138-app";
        "wikibae.de" "138-app";
        "ridges-herb-9.wikibase.cloud" "138-app";
        "eusterm.wikibase.cloud" "138-app";
        "melanges-test.wikibase.cloud" "138-app";
        "berkeleylaw.wikibase.cloud" "138-app";
        "pigeons.wikibase.cloud" "138-app";
        "compoundcloud.wikibase.cloud" "138-app";
        "fedidata.wikibase.cloud" "138-app";
        "frederikwiki.wikibase.cloud" "138-app";
        "ridges-herb.wikibase.cloud" "138-app";
        "privacygraph.wikibase.cloud" "138-app";
        "wei-cheng.wikibase.cloud" "138-app";
        "wikibasetest.wikibase.cloud" "138-app";
        "conscremona.wikibase.cloud" "138-app";
        "demo-conscremona.wikibase.cloud" "138-app";
        "rfc-editor.wikibase.cloud" "138-app";
        "habitsofmind.wikibase.cloud" "138-app";
        "maths-22.wikibase.cloud" "138-app";
        "ecology-22.wikibase.cloud" "138-app";
        "snarc-llgc.wikibase.cloud" "138-app";
        "quotebase.wikibase.cloud" "138-app";
        "data.r74n.com" "138-app";
        "221121-prod-test-wbaas-custom-deer.duckdns.org" "138-app";
        "winedata.wikibase.cloud" "138-app";
        "hunt-museum.wikibase.cloud" "138-app";
        "elections.wikibase.cloud" "138-app";
        "ublmutest.wikibase.cloud" "138-app";
        "oorlogsbronnen.wikibase.cloud" "138-app";
        "ottgaz-test.wikibase.cloud" "138-app";
        "wikiwarp.wikibase.cloud" "138-app";
        "ublmu.wikibase.cloud" "138-app";
        "kb-rda-testwikibase.wikibase.cloud" "138-app";
        "stanford.wikibase.cloud" "138-app";
        "tandori.wikibase.cloud" "138-app";
        "knls-open.wikibase.cloud" "138-app";
        "tw-made-an-instance-of.wikibase.cloud" "138-app";
        "test-lcc.wikibase.cloud" "138-app";
        "maptest.wikibase.cloud" "138-app";
        "catalog-dev.digital-scriptorium.org" "138-app";
        "agausgabemedien.wikibase.cloud" "138-app";
        "test-data.wikibase.cloud" "138-app";
        "catalog.digital-scriptorium.org" "138-app";
        "sandrabecker01.wikibase.cloud" "138-app";
        "starbase.wikibase.cloud" "138-app";
        "scanning.wikibase.cloud" "138-app";
        "kurdi.wikibase.cloud" "138-app";
        "frederik.wikibase.cloud" "138-app";
        "topo-pcrs-geostandard.wikibase.cloud" "138-app";
        "initial-tests-confirm-success.wikibase.cloud" "138-app";
        "nochallengingcharactersatall.wikibase.cloud" "138-app";
        "mycommunityarchives.wikibase.cloud" "138-app";
        "naf-test.wikibase.cloud" "138-app";
        "wmde-test-deer-230110.wikibase.cloud" "138-app";
        "evelien-test.wikibase.cloud" "138-app";
        "other.wikibase.cloud" "138-app";
        "exmusica.wikibase.cloud" "138-app";
        "pbuidev.wikibase.cloud" "138-app";
        "christoslearnswbcloud.wikibase.cloud" "138-app";
        "tarrow-test-53.wikibase.cloud" "138-app";
        "openculturethl.wikibase.cloud" "138-app";
        "enote-playground.wikibase.cloud" "138-app";
        "osobnosti.wikibase.cloud" "138-app";
        "wbwh-test.wikibase.cloud" "138-app";
        "ds20230203.wikibase.cloud" "138-app";
        "cnb-works.wikibase.cloud" "138-app";
        "equips.wikibase.cloud" "138-app";
        "burocracia.wikibase.cloud" "138-app";
        "ld4goats.wikibase.cloud" "138-app";
        "xtexvnet.wikibase.cloud" "138-app";
        "cps2-masters.wikibase.cloud" "138-app";
        "ir-authorities.wikibase.cloud" "138-app";
        "jsamwrites.wikibase.cloud" "138-app";
        "vtul-metadataservices.wikibase.cloud" "138-app";
        "imkg2023.wikibase.cloud" "138-app";
        "researchwb.wikibase.cloud" "138-app";
        "indxr.wikibase.cloud" "138-app";
        "internationaler-sozialistischer-kampfbund.wikibase.cloud" "138-app";
        "internationaler-sozialistischer-kampfbund-test.wikibase.cloud" "138-app";
        "geokb.wikibase.cloud" "138-app";
        "alpes-transport-sandbox.wikibase.cloud" "138-app";
        "podcasts.wikibase.cloud" "138-app";
        "samling.wikibase.cloud" "138-app";
        "cine1803-23.wikibase.cloud" "138-app";
        "dbgi-sandbox.wikibase.cloud" "138-app";
        "fdp-central.wikibase.cloud" "138-app";
        "archaeo3d.wikibase.cloud" "138-app";
        "lgbtdb.wikibase.cloud" "138-app";
        "importer.wikibase.cloud" "138-app";
        "gridobjekt.wikibase.cloud" "138-app";
        "eew-edgi.wikibase.cloud" "138-app";
        "openpharmacopoeia.wikibase.cloud" "138-app";
        "itg-test.wikibase.cloud" "138-app";
        "va-test.wikibase.cloud" "138-app";
        "paleogridd.wikibase.cloud" "138-app";
        "abbreviations.wikibase.cloud" "138-app";
        "metadata-maps.wikibase.cloud" "138-app";
        "kudos.wikibase.cloud" "138-app";
        "magnus.wikibase.cloud" "138-app";
        "horimiya.wikibase.cloud" "138-app";
        "test.lophocmatngu.wiki" "138-app";
        "sciencefictionhistory.wikibase.cloud" "138-app";
        "danish-elite-network.wikibase.cloud" "138-app";
        "aberdeen-arrivals.wikibase.cloud" "138-app";
        "nigeria-ethnic-groups.wikibase.cloud" "138-app";
        "agschemas.wikibase.cloud" "138-app";
        "mw138test.wikibase.cloud" "138-app";
        "bodhitestwiki.wikibase.cloud" "138-app";
        "codethecity.wikibase.cloud" "138-app";
        "plant-collective.wikibase.cloud" "138-app";
        "gridobjecttwo.wikibase.cloud" "138-app";
        "testmundus.wikibase.cloud" "138-app";
        "nekky.wikibase.cloud" "138-app";
        "d063520.wikibase.cloud" "138-app";
        "wiki.hestia.ai" "138-app";
        "wiki.data.foundation" "138-app";
        "hestiaai-test.wikibase.cloud" "138-app";
        "wikibase.juncture-digital.org" "138-app";
}
# Figure out which group of backends we might want to send the request to based on uri
# TODO add Special:EntityData???
map $request_uri $mwgroup {
        ~^/()(w/load.php.*) "web";
        ~^/()(w/api.php.*) "api";
        ~^/()(w/rest.php.*) "api";
        default "web";
}

server {
        listen 8080;
        server_name _; # This is just an invalid value which will never trigger on a real hostname.

        # Resolver is needed when using variables in proxy_pass directives...
        # https://serverfault.com/a/937172
        # https://github.com/kubernetes-sigs/aws-load-balancer-controller/issues/795#issuecomment-451257479
        resolver kube-dns.kube-system.svc.cluster.local valid=10s;

        # IP range matches current kubernetes pod IPs
        set_real_ip_from  10.0.0.0/14;
        real_ip_header X-Forwarded-For;
        proxy_set_header X-Forwarded-For "$proxy_add_x_forwarded_for";

        client_max_body_size                    1m;

        port_in_redirect off;

        proxy_set_header Host                   $http_host;

        # mitigate HTTPoxy Vulnerability
        # https://www.nginx.com/blog/mitigating-the-httpoxy-vulnerability-with-nginx/
        proxy_set_header Proxy                  "";

        proxy_redirect                          off;
        proxy_request_buffering                 on;
        proxy_http_version                      1.1;

        proxy_cookie_domain                     off;
        proxy_cookie_path                       off;

        # In case of errors try the next upstream server before returning an error
        proxy_next_upstream                     error timeout;
        proxy_next_upstream_timeout             0;
        proxy_next_upstream_tries               3;

        # Custom headers to proxied server
        proxy_connect_timeout                   5s;
        proxy_send_timeout                      60s;
        proxy_read_timeout                      60s;

        proxy_buffering                         off;
        proxy_buffer_size                       4k;
        proxy_buffers                           4 4k;

        proxy_max_temp_file_size                1024m;

        # Allowoverriding the group decision using the magic header
        if ($http_x_wbstack_alpha) {
                set $mwgroup "alpha";
        }

        ############# Locations #############

        location = /kube-probe {
                add_header Content-Type text/plain;
                return 200 'gangnam style!';
        }

        location ~* "^/(query/)(sparql.*)" {
                ########################################
                # --- START Blazegraph specific stuff ---
                ########################################

                # Make sure the blazegraph service is readonly
                # TODO maybe the headers and the only GET AND POST should mvoe to the gateway?
                proxy_set_header X-BIGDATA-MAX-QUERY-MILLIS 60000;
                proxy_set_header X-BIGDATA-READ-ONLY "yes";
                limit_except GET OPTIONS POST {
                    deny all;
                }

                add_header Access-Control-Allow-Origin * always;

                # Cache on clients for 5 mins
                add_header Cache-Control "public, max-age=300";
                add_header Vary Accept;

                # Proxy result buffering (not even sure if we want this)
                client_body_buffer_size 1m;
                proxy_buffering on;
                proxy_buffer_size 16k;
                proxy_buffers 256 16k;
                proxy_busy_buffers_size 256k;
                proxy_temp_file_write_size 16k;
                proxy_max_temp_file_size 10m;
                proxy_read_timeout 300;

                ########################################
                # --- END Blazegraph specific stuff ---
                ########################################

                rewrite "(?i)/(query/)(sparql.*)" /$2 break;
                proxy_pass http://queryservice-gateway.default.svc.cluster.local:80;

        }

        location ~* "^/(query)(.*)" {
                rewrite ^(/query)$ $1/ permanent;
                rewrite "(?i)/(query)(.*)" /$2 break;
                proxy_pass http://queryservice-ui:80;

        }

        location ~* "^/(tools/widar)(.*)" {
                rewrite ^(/tools/widar)$ $1/ permanent;
                rewrite "(?i)/(tools/widar)(.*)" /$2 break;
                proxy_pass http://tool-widar:80;

        }

        location ~* "^/(tools/cradle)(.*)" {
                rewrite ^(/tools/cradle)$ $1/ permanent;
                rewrite "(?i)/(tools/cradle)(.*)" /$2 break;
                proxy_pass http://tool-cradle:80;

        }

        location ~* "^/(tools/quickstatements)(.*)" {
                rewrite ^(/tools/quickstatements)$ $1/ permanent;
                rewrite "(?i)/(tools/quickstatements)(.*)" /$2 break;
                proxy_pass http://tool-quickstatements:80;
        }

        location ~* "^/()(.*)" {
                add_header X-WBSTACK-MW-BACKEND mediawiki-$mwversion-$mwgroup;
                proxy_pass http://mediawiki-$mwversion-$mwgroup.default.svc.cluster.local:80;
                rewrite "(?i)/()(.*)" /$2 break;

        }

}
