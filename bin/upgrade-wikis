#!/bin/bash

# This script can be used to run the APIs MediawikiUpdate Job for individual mediawiki databases
# 
# After this script is used you have to point the wikis to the new mediawiki backends.
# Then you can remove the read-only mode again with the script `unlock-wikis`.
#
# `DOMAIN_FILE_LIST` is just the path to a plain-text file containing a list of wikibase.cloud domains, each line containing 1 wiki domain
# in the form of:
# ```
# foo.wikibase.cloud 
# bar.wikibase.cloud
# ``

set -exu

# These need to be adjusted for each upgrade
DOMAIN_FILE_LIST='./domains.txt'
DB_VERSION_OLD='mw1.37-fp-wbs1'
DB_VERSION_NEW='mw1.38-wbs1'
MW_BACKEND='mediawiki-138'

for WIKI_DOMAIN in $(cat ${DOMAIN_FILE_LIST}); do
    kubectl exec -it deployment/api-app-backend -- bash -c "php artisan wbs-wiki:setSetting domain ${WIKI_DOMAIN} wgReadOnly Mediawiki-Upgrade"
    time kubectl exec -it deployments/api-scheduler -- bash -c "php artisan job:dispatchNow MediawikiUpdate wikis.domain ${WIKI_DOMAIN} ${DB_VERSION_OLD} ${DB_VERSION_NEW} ${MW_BACKEND}"
done
