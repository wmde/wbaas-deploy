#!/bin/bash

set -x

function usage() {
    echo
    echo "usage: $(basename $0) <environment> <release-name> [output-file-template]"
    echo
}

# absolute path of the wbaas-deploy repository
ROOT=$(realpath $(dirname $(realpath $BASH_SOURCE))/..)

ENVIRONMENT="$1"
RELEASE="$2"

OUTPUT="${ROOT}/k8s/argocd/${ENVIRONMENT}/${RELEASE}.values.yaml"
HELMFILE="k8s/helmfile/helmfile.yaml"

if [[ -n "$3" ]]; then
    OUTPUT="$3"
fi

if [[ ! -e "${HELMFILE}" ]]; then
    echo "error: helmfile not found: '${HELMFILE}'"
    usage
    exit 1 
fi

if [[ -z "${ENVIRONMENT}" ]]; then
    echo "error: missing environment"
    usage
    exit 2
fi

if [[ -z "${RELEASE}" ]]; then
    echo "error: missing release name"
    usage
    exit 3
fi

helmfile \
    --file "${HELMFILE}" \
    --environment "${ENVIRONMENT}" \
    --selector name="${RELEASE}" \
    --output-file-template "${OUTPUT}" \
    --skip-deps \
    write-values

# fix indentation for yamllint action
yq -I 2 -i "${OUTPUT}"
