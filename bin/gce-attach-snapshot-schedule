#!/usr/bin/env bash
# This script tries to compose a command for attaching a snapshot schedule to the SQL replica disk

SNAPSHOT_POLICY="wbcloud-nightly-west-to-north-7d-1"
PVC="data-sql-mariadb-secondary-0"

PV=$(kubectl get pvc ${PVC} -o jsonpath="{.spec.volumeName}")

# matches metadata of disks provisioned via bitnami mariadb chart
DISK=$(kubectl get pv ${PV} -o jsonpath="{.spec.csi.volumeHandle}" | awk -F '/' '{print $NF}')

# if the $DISK is empty, check if it was provisioned by terraform
if [[ -z "$DISK" ]]; then
    DISK=$(kubectl get pv ${PV} -o jsonpath="{.spec.gcePersistentDisk.pdName}")
fi

LOCATION=$(gcloud compute disks list --filter="name=('${DISK}')" --format='value(location())')

echo "context: '$(kubectl config current-context)'"
echo "disk:    '${DISK}' (located in '${LOCATION}')"
echo "policy:  '${SNAPSHOT_POLICY}'"
echo
echo "> gcloud compute disks add-resource-policies ${DISK} --zone=${LOCATION} --resource-policies=${SNAPSHOT_POLICY}"
echo