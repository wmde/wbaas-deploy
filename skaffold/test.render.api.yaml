apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    app.kubernetes.io/instance: api
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: api
    app.kubernetes.io/version: "1.0"
    helm.sh/chart: api-0.32.1
  name: api-defaultrole
---
apiVersion: v1
data:
  oauth-private.key: Y29udGVudE9mUHJpdmF0ZUtleQ==
  oauth-public.key: Y29udGVudE9mUHVibGljS2V5
kind: Secret
metadata:
  labels:
    app.kubernetes.io/instance: api
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: api
    helm.sh/chart: api-0.32.1
  name: api-app-passport-keys
type: Opaque
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    app.kubernetes.io/instance: api
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: api
    app.kubernetes.io/version: "1.0"
    helm.sh/chart: api-0.32.1
  name: api-defaultrole
rules:
  - apiGroups:
      - extensions
      - networking.k8s.io
    resources:
      - ingresses
    verbs:
      - get
      - create
      - list
  - apiGroups:
      - ""
    resources:
      - pods
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - batch
    resources:
      - jobs
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
  - apiGroups:
      - ""
    resources:
      - configmaps
    verbs:
      - get
      - list
      - update
      - patch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    app.kubernetes.io/instance: api
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: api
    app.kubernetes.io/version: "1.0"
    helm.sh/chart: api-0.32.1
  name: api-defaultrole
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: api-defaultrole
subjects:
  - kind: ServiceAccount
    name: api-defaultrole
    namespace: default
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/component: app-backend
    app.kubernetes.io/instance: api
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: api
    app.kubernetes.io/version: "1.0"
    helm.sh/chart: api-0.32.1
  name: api-app-backend
spec:
  ports:
    - name: http
      port: 80
      protocol: TCP
      targetPort: http
  selector:
    app.kubernetes.io/component: app-backend
    app.kubernetes.io/instance: api
    app.kubernetes.io/name: api
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/instance: api
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: api
    app.kubernetes.io/version: "1.0"
    helm.sh/chart: api-0.32.1
  name: api-app-web
spec:
  ports:
    - name: http
      port: 80
      protocol: TCP
      targetPort: http
  selector:
    app.kubernetes.io/component: app-web
    app.kubernetes.io/instance: api
    app.kubernetes.io/name: api
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/instance: api
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: api
    app.kubernetes.io/version: "1.0"
    helm.sh/chart: api-0.32.1
  name: api-app-backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: app-backend
      app.kubernetes.io/instance: api
      app.kubernetes.io/name: api
  template:
    metadata:
      labels:
        app.kubernetes.io/component: app-backend
        app.kubernetes.io/instance: api
        app.kubernetes.io/name: api
    spec:
      containers:
        - env:
            - name: CONTAINER_ROLE
              value: app
            - name: ROUTES_LOAD_WEB
              value: "0"
            - name: ROUTES_LOAD_BACKEND
              value: "1"
            - name: APP_NAME
              value: WBaaS Localhost
            - name: APP_ENV
              value: local
            - name: APP_KEY
              valueFrom:
                secretKeyRef:
                  key: api-app-key
                  name: api-app-secrets
            - name: APP_DEBUG
              value: "true"
            - name: APP_URL
              value: https://www.wbaas.dev
            - name: APP_TIMEZONE
              value: UTC
            - name: WBSTACK_SUBDOMAIN_SUFFIX
              value: .wbaas.dev
            - name: WBSTACK_UI_URL
              value: https://wbaas.dev
            - name: WBSTACK_WIKI_DB_PROVISION_VERSION
              value: mw1.39-wbs1
            - name: WBSTACK_WIKI_DB_USE_VERSION
              value: mw1.39-wbs1
            - name: WBSTACK_SUMMARY_CREATION_RATE_RANGES
              value: PT24H,P30D
            - name: WBSTACK_SIGNUP_THROTTLING_LIMIT
              value: "20"
            - name: WBSTACK_SIGNUP_THROTTLING_RANGE
              value: PT24H
            - name: WBSTACK_QS_BATCH_PENDING_TIMEOUT
              value: PT300S
            - name: WBSTACK_QS_BATCH_MARK_FAILED_AFTER
              value: "3"
            - name: WBSTACK_CONTACT_MAIL_RECIPIENT
              value: someone@wikimedia.de
            - name: WBSTACK_CONTACT_MAIL_SENDER
              value: contact-<subject>@wikibase.cloud
            - name: WBSTACK_ELASTICSEARCH_ENABLED_BY_DEFAULT
              value: "true"
            - name: TRUSTED_PROXY_PROXIES
              value: '*'
            - name: ELASTICSEARCH_SHARED_INDEX_HOST
              value: elasticsearch-2.default.svc.cluster.local:9200
            - name: ELASTICSEARCH_SHARED_INDEX_PREFIX
              value: wiki_1
            - name: QUERY_SERVICE_HOST
              value: queryservice.default.svc.cluster.local:9999
            - name: PLATFORM_MW_BACKEND_HOST
              value: mediawiki-139-app-backend.default.svc.cluster.local
            - name: REDIS_HOST
              value: redis-master.default.svc.cluster.local
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: password
                  name: redis-password
            - name: REDIS_PORT
              value: "6379"
            - name: REDIS_DB
              value: "2"
            - name: REDIS_CACHE_DB
              value: "3"
            - name: REDIS_PREFIX
              value: wikibase_dev_api
            - name: MAIL_MAILER
              value: smtp
            - name: MAILGUN_DOMAIN
              value: sandbox111.mailgun.org
            - name: MAILGUN_SECRET
              value: abc123
            - name: MAIL_FROM_ADDRESS
              value: noreply-local@fake.wikibase.dev
            - name: MAIL_FROM_NAME
              value: Wikibase-dev
            - name: MAIL_HOST
              value: mailhog
            - name: MAIL_PORT
              value: "1025"
            - name: MAIL_ENCRYPTION
              value: null
            - name: MAIL_USERNAME
            - name: MAIL_PASSWORD
            - name: GOOGLE_CLOUD_PROJECT_ID
              value: something
            - name: GOOGLE_CLOUD_STORAGE_BUCKET
              valueFrom:
                configMapKeyRef:
                  key: gcs_api_static_bucket_name
                  name: storage-bucket
                  optional: true
            - name: GOOGLE_CLOUD_STORAGE_KEY_FILE
              value: /var/run/secret/cloud.google.com/key.json
            - name: LOG_CHANNEL
              value: stderr
            - name: LOG_LEVEL
              value: debug
            - name: STACKDRIVER_ENABLED
              value: "false"
            - name: STACKDRIVER_PROJECT_ID
              value: something
            - name: STACKDRIVER_LOGGING_ENABLED
              value: "false"
            - name: STACKDRIVER_TRACING_ENABLED
              value: "false"
            - name: STACKDRIVER_ERROR_REPORTING_ENABLED
              value: "true"
            - name: STACKDRIVER_KEY_FILE_PATH
              value: /var/run/secret/cloud.google.com/key.json
            - name: STACKDRIVER_ERROR_REPORTING_BATCH_ENABLED
              value: "false"
            - name: STACKDRIVER_LOGGING_BATCH_ENABLED
              value: "false"
            - name: CACHE_DRIVER
              value: redis
            - name: QUEUE_CONNECTION
              value: redis
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  key: api-app-jwt-secret
                  name: api-app-secrets
            - name: DB_CONNECTION
              value: mysql
            - name: DB_HOST_READ
              value: sql-mariadb-secondary.default.svc.cluster.local
            - name: DB_HOST_WRITE
              value: sql-mariadb-primary.default.svc.cluster.local
            - name: DB_PORT
              value: "3306"
            - name: DB_DATABASE
              value: apidb
            - name: DB_USERNAME
              value: apiuser
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: SQL_INIT_PASSWORD_API
                  name: sql-secrets-init-passwords
            - name: PASSPORT_PUBLIC_KEY
              valueFrom:
                secretKeyRef:
                  key: oauth-public.key
                  name: api-passport-keys
            - name: PASSPORT_PRIVATE_KEY
              valueFrom:
                secretKeyRef:
                  key: oauth-private.key
                  name: api-passport-keys
          image: local/skaffold/wbaas/api:10x.18.9-1-ga5d3aa8
          imagePullPolicy: Never
          livenessProbe:
            failureThreshold: 3
            httpGet:
              path: /backend/healthz
              port: http
            initialDelaySeconds: 10
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 2
          name: api-backend
          ports:
            - containerPort: 80
              name: http
              protocol: TCP
          readinessProbe:
            failureThreshold: 3
            httpGet:
              path: /backend/healthz
              port: http
            initialDelaySeconds: 10
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 2
          resources:
            limits:
              cpu: 1000m
              memory: 600Mi
            requests:
              cpu: 500m
              memory: 300Mi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/instance: api
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: api
    app.kubernetes.io/version: "1.0"
    helm.sh/chart: api-0.32.1
  name: api-app-web
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: app-web
      app.kubernetes.io/instance: api
      app.kubernetes.io/name: api
  template:
    metadata:
      labels:
        app.kubernetes.io/component: app-web
        app.kubernetes.io/instance: api
        app.kubernetes.io/name: api
    spec:
      containers:
        - env:
            - name: CONTAINER_ROLE
              value: app
            - name: ROUTES_LOAD_WEB
              value: "1"
            - name: ROUTES_LOAD_SANDBOX
              value: "0"
            - name: ROUTES_LOAD_BACKEND
              value: "0"
            - name: APP_NAME
              value: WBaaS Localhost
            - name: APP_ENV
              value: local
            - name: APP_KEY
              valueFrom:
                secretKeyRef:
                  key: api-app-key
                  name: api-app-secrets
            - name: APP_DEBUG
              value: "false"
            - name: APP_URL
              value: https://www.wbaas.dev
            - name: APP_TIMEZONE
              value: UTC
            - name: WBSTACK_SUBDOMAIN_SUFFIX
              value: .wbaas.dev
            - name: WBSTACK_UI_URL
              value: https://wbaas.dev
            - name: WBSTACK_WIKI_DB_PROVISION_VERSION
              value: mw1.39-wbs1
            - name: WBSTACK_WIKI_DB_USE_VERSION
              value: mw1.39-wbs1
            - name: WBSTACK_SUMMARY_CREATION_RATE_RANGES
              value: PT24H,P30D
            - name: WBSTACK_SIGNUP_THROTTLING_LIMIT
              value: "20"
            - name: WBSTACK_SIGNUP_THROTTLING_RANGE
              value: PT24H
            - name: WBSTACK_QS_BATCH_PENDING_TIMEOUT
              value: PT300S
            - name: WBSTACK_QS_BATCH_MARK_FAILED_AFTER
              value: "3"
            - name: WBSTACK_CONTACT_MAIL_RECIPIENT
              value: someone@wikimedia.de
            - name: WBSTACK_CONTACT_MAIL_SENDER
              value: contact-<subject>@wikibase.cloud
            - name: WBSTACK_ELASTICSEARCH_ENABLED_BY_DEFAULT
              value: "true"
            - name: TRUSTED_PROXY_PROXIES
              value: '*'
            - name: ELASTICSEARCH_SHARED_INDEX_HOST
              value: elasticsearch-2.default.svc.cluster.local:9200
            - name: ELASTICSEARCH_SHARED_INDEX_PREFIX
              value: wiki_1
            - name: QUERY_SERVICE_HOST
              value: queryservice.default.svc.cluster.local:9999
            - name: PLATFORM_MW_BACKEND_HOST
              value: mediawiki-139-app-backend.default.svc.cluster.local
            - name: REDIS_HOST
              value: redis-master.default.svc.cluster.local
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: password
                  name: redis-password
            - name: REDIS_PORT
              value: "6379"
            - name: REDIS_DB
              value: "2"
            - name: REDIS_CACHE_DB
              value: "3"
            - name: REDIS_PREFIX
              value: wikibase_dev_api
            - name: MAIL_MAILER
              value: smtp
            - name: MAILGUN_DOMAIN
              value: sandbox111.mailgun.org
            - name: MAILGUN_SECRET
              value: abc123
            - name: MAIL_FROM_ADDRESS
              value: noreply-local@fake.wikibase.dev
            - name: MAIL_FROM_NAME
              value: Wikibase-dev
            - name: MAIL_HOST
              value: mailhog
            - name: MAIL_PORT
              value: "1025"
            - name: MAIL_ENCRYPTION
              value: null
            - name: MAIL_USERNAME
            - name: MAIL_PASSWORD
            - name: STATIC_STORAGE_BUCKET_NAME
              valueFrom:
                configMapKeyRef:
                  key: gcs_api_static_bucket_name
                  name: storage-bucket
                  optional: true
            - name: STATIC_STORAGE_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  key: rootUser
                  name: minio-credentials
            - name: STATIC_STORAGE_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  key: rootPassword
                  name: minio-credentials
            - name: STATIC_STORAGE_ENDPOINT
              value: http://minio.default.svc.cluster.local:9000
            - name: STATIC_STORAGE_URL
              value: http://minio.wbaas.dev/api-assets
            - name: STATIC_STORAGE_USE_BUCKET_ENDPOINT
              value: "0"
            - name: STATIC_STORAGE_USE_PATH_STYLE_ENDPOINT
              value: "1"
            - name: STATIC_STORAGE_REGION
              value: us-east-1
            - name: RECAPTCHA_V3_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  key: secret_key
                  name: recaptcha-v3-secrets
            - name: RECAPTCHA_V3_MIN_SCORE
              value: "0.5"
            - name: LOG_CHANNEL
              value: stderr
            - name: LOG_LEVEL
              value: debug
            - name: STACKDRIVER_ENABLED
              value: "false"
            - name: STACKDRIVER_PROJECT_ID
              value: something
            - name: STACKDRIVER_LOGGING_ENABLED
              value: "false"
            - name: STACKDRIVER_TRACING_ENABLED
              value: "false"
            - name: STACKDRIVER_ERROR_REPORTING_ENABLED
              value: "true"
            - name: STACKDRIVER_KEY_FILE_PATH
              value: /var/run/secret/cloud.google.com/key.json
            - name: STACKDRIVER_ERROR_REPORTING_BATCH_ENABLED
              value: "false"
            - name: STACKDRIVER_LOGGING_BATCH_ENABLED
              value: "false"
            - name: CACHE_DRIVER
              value: redis
            - name: QUEUE_CONNECTION
              value: redis
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  key: api-app-jwt-secret
                  name: api-app-secrets
            - name: DB_CONNECTION
              value: mysql
            - name: DB_HOST_READ
              value: sql-mariadb-secondary.default.svc.cluster.local
            - name: DB_HOST_WRITE
              value: sql-mariadb-primary.default.svc.cluster.local
            - name: DB_PORT
              value: "3306"
            - name: DB_DATABASE
              value: apidb
            - name: DB_USERNAME
              value: apiuser
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: SQL_INIT_PASSWORD_API
                  name: sql-secrets-init-passwords
            - name: PASSPORT_PUBLIC_KEY
              valueFrom:
                secretKeyRef:
                  key: oauth-public.key
                  name: api-passport-keys
            - name: PASSPORT_PRIVATE_KEY
              valueFrom:
                secretKeyRef:
                  key: oauth-private.key
                  name: api-passport-keys
          image: local/skaffold/wbaas/api:10x.18.9-1-ga5d3aa8
          imagePullPolicy: Never
          livenessProbe:
            failureThreshold: 3
            httpGet:
              path: /healthz
              port: http
            initialDelaySeconds: 10
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 2
          name: api-web
          ports:
            - containerPort: 80
              name: http
              protocol: TCP
          readinessProbe:
            failureThreshold: 3
            httpGet:
              path: /healthz
              port: http
            initialDelaySeconds: 10
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 2
          resources:
            limits:
              cpu: 250m
              memory: 400Mi
            requests:
              cpu: 100m
              memory: 340Mi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/instance: api
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: api
    app.kubernetes.io/version: "1.0"
    helm.sh/chart: api-0.32.1
  name: api-queue-default
spec:
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/component: queue-default
      app.kubernetes.io/instance: api
      app.kubernetes.io/name: api
  template:
    metadata:
      labels:
        app.kubernetes.io/component: queue-default
        app.kubernetes.io/instance: api
        app.kubernetes.io/name: api
    spec:
      containers:
        - env:
            - name: CONTAINER_ROLE
              value: queue
            - name: APP_NAME
              value: WBaaS Localhost
            - name: APP_ENV
              value: local
            - name: APP_KEY
              valueFrom:
                secretKeyRef:
                  key: api-app-key
                  name: api-app-secrets
            - name: APP_DEBUG
              value: "false"
            - name: APP_URL
              value: https://www.wbaas.dev
            - name: APP_TIMEZONE
              value: UTC
            - name: WBSTACK_SUBDOMAIN_SUFFIX
              value: .wbaas.dev
            - name: WBSTACK_UI_URL
              value: https://wbaas.dev
            - name: WBSTACK_WIKI_DB_PROVISION_VERSION
              value: mw1.39-wbs1
            - name: WBSTACK_WIKI_DB_USE_VERSION
              value: mw1.39-wbs1
            - name: WBSTACK_SUMMARY_CREATION_RATE_RANGES
              value: PT24H,P30D
            - name: WBSTACK_SIGNUP_THROTTLING_LIMIT
              value: "20"
            - name: WBSTACK_SIGNUP_THROTTLING_RANGE
              value: PT24H
            - name: WBSTACK_QS_BATCH_PENDING_TIMEOUT
              value: PT300S
            - name: WBSTACK_QS_BATCH_MARK_FAILED_AFTER
              value: "3"
            - name: WBSTACK_CONTACT_MAIL_RECIPIENT
              value: someone@wikimedia.de
            - name: WBSTACK_CONTACT_MAIL_SENDER
              value: contact-<subject>@wikibase.cloud
            - name: WBSTACK_ELASTICSEARCH_ENABLED_BY_DEFAULT
              value: "true"
            - name: TRUSTED_PROXY_PROXIES
              value: '*'
            - name: ELASTICSEARCH_SHARED_INDEX_HOST
              value: elasticsearch-2.default.svc.cluster.local:9200
            - name: ELASTICSEARCH_SHARED_INDEX_PREFIX
              value: wiki_1
            - name: CURLOPT_TIMEOUT_ELASTICSEARCH_INIT
              value: "500"
            - name: ELASTICSEARCH_HOST
              value: elasticsearch-1.default.svc.cluster.local:9200
            - name: QUERY_SERVICE_HOST
              value: queryservice.default.svc.cluster.local:9999
            - name: PLATFORM_MW_BACKEND_HOST
              value: mediawiki-139-app-backend.default.svc.cluster.local
            - name: REDIS_HOST
              value: redis-master.default.svc.cluster.local
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: password
                  name: redis-password
            - name: REDIS_PORT
              value: "6379"
            - name: REDIS_DB
              value: "2"
            - name: REDIS_CACHE_DB
              value: "3"
            - name: REDIS_PREFIX
              value: wikibase_dev_api
            - name: MAIL_MAILER
              value: smtp
            - name: MAILGUN_DOMAIN
              value: sandbox111.mailgun.org
            - name: MAILGUN_SECRET
              value: abc123
            - name: MAIL_FROM_ADDRESS
              value: noreply-local@fake.wikibase.dev
            - name: MAIL_FROM_NAME
              value: Wikibase-dev
            - name: MAIL_HOST
              value: mailhog
            - name: MAIL_PORT
              value: "1025"
            - name: MAIL_ENCRYPTION
              value: null
            - name: MAIL_USERNAME
            - name: MAIL_PASSWORD
            - name: STATIC_STORAGE_BUCKET_NAME
              valueFrom:
                configMapKeyRef:
                  key: gcs_api_static_bucket_name
                  name: storage-bucket
                  optional: true
            - name: STATIC_STORAGE_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  key: rootUser
                  name: minio-credentials
            - name: STATIC_STORAGE_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  key: rootPassword
                  name: minio-credentials
            - name: STATIC_STORAGE_ENDPOINT
              value: http://minio.default.svc.cluster.local:9000
            - name: STATIC_STORAGE_URL
              value: http://minio.wbaas.dev/api-assets
            - name: STATIC_STORAGE_USE_BUCKET_ENDPOINT
              value: "0"
            - name: STATIC_STORAGE_USE_PATH_STYLE_ENDPOINT
              value: "1"
            - name: STATIC_STORAGE_REGION
              value: us-east-1
            - name: LOG_CHANNEL
              value: stderr
            - name: LOG_LEVEL
              value: debug
            - name: STACKDRIVER_ENABLED
              value: "false"
            - name: STACKDRIVER_PROJECT_ID
              value: something
            - name: STACKDRIVER_LOGGING_ENABLED
              value: "false"
            - name: STACKDRIVER_TRACING_ENABLED
              value: "false"
            - name: STACKDRIVER_ERROR_REPORTING_ENABLED
              value: "true"
            - name: STACKDRIVER_KEY_FILE_PATH
              value: /var/run/secret/cloud.google.com/key.json
            - name: STACKDRIVER_ERROR_REPORTING_BATCH_ENABLED
              value: "false"
            - name: STACKDRIVER_LOGGING_BATCH_ENABLED
              value: "false"
            - name: CACHE_DRIVER
              value: redis
            - name: QUEUE_NAME
              value: default
            - name: QUEUE_CONNECTION
              value: redis
            - name: QUEUE_BACKOFF
              value: 10,60,300,900,1500
            - name: HORIZON_ENABLED
              value: "1"
            - name: HORIZON_QUEUE_NAMES
              value: default,manual-intervention
            - name: HORIZON_MAX_PROCESSES
              value: "10"
            - name: HORIZON_MIN_PROCESSES
              value: "1"
            - name: HORIZON_BALANCING_STRATEGY
              value: auto
            - name: HORIZON_AUTO_SCALING_STRATEGY
              value: time
            - name: HORIZON_MAX_SHIFT
              value: "1"
            - name: HORIZON_COOL_DOWN
              value: "3"
            - name: HORIZON_MEMORY
              value: "128"
            - name: HORIZON_TRIES
              value: "3"
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  key: api-app-jwt-secret
                  name: api-app-secrets
            - name: DB_CONNECTION
              value: mysql
            - name: DB_HOST_READ
              value: sql-mariadb-secondary.default.svc.cluster.local
            - name: DB_HOST_WRITE
              value: sql-mariadb-primary.default.svc.cluster.local
            - name: DB_PORT
              value: "3306"
            - name: DB_DATABASE
              value: apidb
            - name: DB_USERNAME
              value: apiuser
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: SQL_INIT_PASSWORD_API
                  name: sql-secrets-init-passwords
            - name: MW_DB_HOST_READ
              value: sql-mariadb-secondary.default.svc.cluster.local
            - name: MW_DB_HOST_WRITE
              value: sql-mariadb-primary.default.svc.cluster.local
            - name: MW_DB_USERNAME
              value: mediawiki-db-manager
            - name: MW_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: SQL_INIT_PASSWORD_MW
                  name: sql-secrets-init-passwords
            - name: PASSPORT_PUBLIC_KEY
              valueFrom:
                secretKeyRef:
                  key: oauth-public.key
                  name: api-passport-keys
            - name: PASSPORT_PRIVATE_KEY
              valueFrom:
                secretKeyRef:
                  key: oauth-private.key
                  name: api-passport-keys
            - name: API_JOB_NAMESPACE
              value: api-jobs
          image: local/skaffold/wbaas/api:10x.18.9-1-ga5d3aa8
          imagePullPolicy: Never
          name: api-queue-default
          ports:
            - containerPort: 80
              name: http
              protocol: TCP
          resources:
            limits:
              cpu: 250m
              memory: 512Mi
            requests:
              cpu: 100m
              memory: 256Mi
      serviceAccountName: api-defaultrole
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/instance: api
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: api
    app.kubernetes.io/version: "1.0"
    helm.sh/chart: api-0.32.1
  name: api-scheduler
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: scheduler
      app.kubernetes.io/instance: api
      app.kubernetes.io/name: api
  template:
    metadata:
      labels:
        app.kubernetes.io/component: scheduler
        app.kubernetes.io/instance: api
        app.kubernetes.io/name: api
    spec:
      containers:
        - env:
            - name: CONTAINER_ROLE
              value: scheduler
            - name: APP_NAME
              value: WBaaS Localhost
            - name: APP_ENV
              value: local
            - name: APP_KEY
              valueFrom:
                secretKeyRef:
                  key: api-app-key
                  name: api-app-secrets
            - name: APP_DEBUG
              value: "false"
            - name: APP_URL
              value: https://www.wbaas.dev
            - name: APP_TIMEZONE
              value: UTC
            - name: WBSTACK_SUBDOMAIN_SUFFIX
              value: .wbaas.dev
            - name: WBSTACK_UI_URL
              value: https://wbaas.dev
            - name: WBSTACK_WIKI_DB_PROVISION_VERSION
              value: mw1.39-wbs1
            - name: WBSTACK_WIKI_DB_USE_VERSION
              value: mw1.39-wbs1
            - name: WBSTACK_SUMMARY_CREATION_RATE_RANGES
              value: PT24H,P30D
            - name: WBSTACK_SIGNUP_THROTTLING_LIMIT
              value: "20"
            - name: WBSTACK_SIGNUP_THROTTLING_RANGE
              value: PT24H
            - name: WBSTACK_QS_BATCH_PENDING_TIMEOUT
              value: PT300S
            - name: WBSTACK_QS_BATCH_MARK_FAILED_AFTER
              value: "3"
            - name: WBSTACK_CONTACT_MAIL_RECIPIENT
              value: someone@wikimedia.de
            - name: WBSTACK_CONTACT_MAIL_SENDER
              value: contact-<subject>@wikibase.cloud
            - name: WBSTACK_ELASTICSEARCH_ENABLED_BY_DEFAULT
              value: "true"
            - name: TRUSTED_PROXY_PROXIES
              value: '*'
            - name: ELASTICSEARCH_SHARED_INDEX_HOST
              value: elasticsearch-2.default.svc.cluster.local:9200
            - name: ELASTICSEARCH_SHARED_INDEX_PREFIX
              value: wiki_1
            - name: QUERY_SERVICE_HOST
              value: queryservice.default.svc.cluster.local:9999
            - name: PLATFORM_MW_BACKEND_HOST
              value: mediawiki-139-app-backend.default.svc.cluster.local
            - name: REDIS_HOST
              value: redis-master.default.svc.cluster.local
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: password
                  name: redis-password
            - name: REDIS_PORT
              value: "6379"
            - name: REDIS_DB
              value: "2"
            - name: REDIS_CACHE_DB
              value: "3"
            - name: REDIS_PREFIX
              value: wikibase_dev_api
            - name: MAIL_MAILER
              value: smtp
            - name: MAILGUN_DOMAIN
              value: sandbox111.mailgun.org
            - name: MAILGUN_SECRET
              value: abc123
            - name: MAIL_FROM_ADDRESS
              value: noreply-local@fake.wikibase.dev
            - name: MAIL_FROM_NAME
              value: Wikibase-dev
            - name: MAIL_HOST
              value: mailhog
            - name: MAIL_PORT
              value: "1025"
            - name: MAIL_ENCRYPTION
              value: null
            - name: MAIL_USERNAME
            - name: MAIL_PASSWORD
            - name: GOOGLE_CLOUD_PROJECT_ID
              value: something
            - name: GOOGLE_CLOUD_STORAGE_BUCKET
              valueFrom:
                configMapKeyRef:
                  key: gcs_api_static_bucket_name
                  name: storage-bucket
                  optional: true
            - name: GOOGLE_CLOUD_STORAGE_KEY_FILE
              value: /var/run/secret/cloud.google.com/key.json
            - name: LOG_CHANNEL
              value: stderr
            - name: LOG_LEVEL
              value: debug
            - name: STACKDRIVER_ENABLED
              value: "false"
            - name: STACKDRIVER_PROJECT_ID
              value: something
            - name: STACKDRIVER_LOGGING_ENABLED
              value: "false"
            - name: STACKDRIVER_TRACING_ENABLED
              value: "false"
            - name: STACKDRIVER_ERROR_REPORTING_ENABLED
              value: "true"
            - name: STACKDRIVER_KEY_FILE_PATH
              value: /var/run/secret/cloud.google.com/key.json
            - name: STACKDRIVER_ERROR_REPORTING_BATCH_ENABLED
              value: "false"
            - name: STACKDRIVER_LOGGING_BATCH_ENABLED
              value: "false"
            - name: CACHE_DRIVER
              value: redis
            - name: QUEUE_CONNECTION
              value: redis
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  key: api-app-jwt-secret
                  name: api-app-secrets
            - name: DB_CONNECTION
              value: mysql
            - name: DB_HOST_READ
              value: sql-mariadb-secondary.default.svc.cluster.local
            - name: DB_HOST_WRITE
              value: sql-mariadb-primary.default.svc.cluster.local
            - name: DB_PORT
              value: "3306"
            - name: DB_DATABASE
              value: apidb
            - name: DB_USERNAME
              value: apiuser
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: SQL_INIT_PASSWORD_API
                  name: sql-secrets-init-passwords
            - name: PASSPORT_PUBLIC_KEY
              valueFrom:
                secretKeyRef:
                  key: oauth-public.key
                  name: api-passport-keys
            - name: PASSPORT_PRIVATE_KEY
              valueFrom:
                secretKeyRef:
                  key: oauth-private.key
                  name: api-passport-keys
          image: local/skaffold/wbaas/api:10x.18.9-1-ga5d3aa8
          imagePullPolicy: Never
          name: api-queue
          ports:
            - containerPort: 80
              name: http
              protocol: TCP
          resources:
            limits:
              cpu: 40m
              memory: 80Mi
            requests:
              cpu: 5m
              memory: 20Mi
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    nginx.ingress.kubernetes.io/use-regex: "true"
  labels:
    app.kubernetes.io/instance: api
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: api
    app.kubernetes.io/version: "1.0"
    helm.sh/chart: api-0.32.1
  name: api
spec:
  rules:
    - host: api.wbaas.dev
      http:
        paths:
          - backend:
              service:
                name: api-app-web
                port:
                  name: http
            path: /()(.*)
            pathType: Prefix
    - host: www.wbaas.dev
      http:
        paths:
          - backend:
              service:
                name: api-app-web
                port:
                  name: http
            path: /api(/|$)(.*)
            pathType: Prefix
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    monitoring: platform-api
    release: kube-prometheus-stack
  name: platform-api-servicemonitor
  namespace: monitoring
spec:
  endpoints:
    - interval: 10s
      path: /metrics
      port: http
  namespaceSelector:
    any: true
  selector:
    matchLabels:
      app.kubernetes.io/component: app-backend
      app.kubernetes.io/instance: api
---
# Source: api/templates/tests/test-connection.yaml
apiVersion: v1
kind: Pod
metadata:
  name: "api-test-connection"
  labels:
    app.kubernetes.io/name: api
    helm.sh/chart: api-0.32.1
    app.kubernetes.io/instance: api
    app.kubernetes.io/version: "1.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    "helm.sh/hook": test-success
spec:
  containers:
    - name: wget
      image: busybox
      command: ['wget']
      args:  ['api:80']
  restartPolicy: Never
---
# Source: api/templates/pre-install-job.yaml
# Copied from & Modified: https://github.com/helm/helm/blob/master/docs/examples/nginx/templates/post-install-job.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: api-pre-install-artisan-setup
  labels:
    # The "app.kubernetes.io/managed-by" label is used to track which tool deployed a given chart.
    # It is useful for admins who want to see what releases a particular tool
    # is responsible for.
    app.kubernetes.io/managed-by: Helm
    # The "app.kubernetes.io/instance" convention makes it easy to tie a release to all of the
    # Kubernetes resources that were created as part of that release.
    app.kubernetes.io/instance: api
    # This makes it easy to audit chart usage.
    helm.sh/chart: api-0.32.1
    app.kubernetes.io/name: api
  annotations:
    # This is what defines this resource as a hook. Without this line, the
    # job is considered part of the release.
    # Docs: https://github.com/helm/helm/blob/master/docs/charts_hooks.md
    "helm.sh/hook": pre-install
spec:
  template:
    metadata:
      name: api
      labels:
        app.kubernetes.io/instance: api
        app.kubernetes.io/name: api
    spec:
      restartPolicy: OnFailure
      containers:
        - name: pre-install-job
          image: "local/skaffold/wbaas/api:10x.18.9-1-ga5d3aa8"
          imagePullPolicy: Never
          # All we're going to do is sleep for a while, then exit.
          # TODO this could actually make the db user we need and also have the correct permissions?
          command: ["/bin/sh"]
          # --force is needed for applying migrations while APP_ENV is production
          args: ["-c", "php artisan migrate:install; php artisan migrate --force; php artisan passport:client --personal --no-interaction; php artisan passport:client --password --no-interaction"]
          # TODO the env vars are mostly copied from the deployment, is there a way to reuse?
          env:
          - name: CONTAINER_ROLE
            value: app
          - name: APP_NAME
            value: "WBaaS Localhost"
          - name: APP_ENV
            value: "local"
          - name: APP_KEY
            valueFrom:
              secretKeyRef:
                name: "api-app-secrets"
                key: "api-app-key"
          - name: APP_DEBUG
            value: "false"
          - name: APP_URL
            value: "https://www.wbaas.dev"
          - name: APP_TIMEZONE
            value: "UTC"

          - name: REDIS_HOST
            value: "redis-master.default.svc.cluster.local"
          - name: REDIS_PORT
            value: "6379"
          - name: REDIS_PASSWORD
            valueFrom:
              secretKeyRef:
                name: "redis-password"
                key: "password"
          - name: REDIS_DB
            value: "2"
          - name: REDIS_CACHE_DB
            value: "3"
          - name: REDIS_PREFIX
            value: "wikibase_dev_api"

          - name: MAIL_MAILER
            value: "smtp"
          - name: MAILGUN_DOMAIN
            value: "sandbox111.mailgun.org"
          - name: MAILGUN_SECRET
            value: "abc123"
          - name: MAIL_FROM_ADDRESS
            value: "noreply-local@fake.wikibase.dev"
          - name: MAIL_FROM_NAME
            value: "Wikibase-dev"

          - name: ROUTES_LOAD_WEB
            value: "1"
          - name: ROUTES_LOAD_BACKEND
            value: "1"

          - name: LOG_CHANNEL
            value: stderr
          - name: STACKDRIVER_ENABLED
            value: "false"
          - name: STACKDRIVER_PROJECT_ID
            value: "something"
          - name: STACKDRIVER_LOGGING_ENABLED
            value: "false"
          - name: STACKDRIVER_TRACING_ENABLED
            value: "false"
          - name: STACKDRIVER_ERROR_REPORTING_ENABLED
            value: "true"
          - name: STACKDRIVER_KEY_FILE_PATH
            value: /var/run/secret/cloud.google.com/key.json
          - name: STACKDRIVER_ERROR_REPORTING_BATCH_ENABLED
            value: "false"
          - name: STACKDRIVER_LOGGING_BATCH_ENABLED
            value: "false"

          - name: CACHE_DRIVER
            value: "redis"
          - name: QUEUE_CONNECTION
            value: "redis"
          - name: JWT_SECRET
            valueFrom:
              secretKeyRef:
                name: "api-app-secrets"
                key: "api-app-jwt-secret"
          - name: DB_CONNECTION
            value: "mysql"
            # TODO from service discovery or something?
          - name: DB_HOST_READ
            value: "sql-mariadb-secondary.default.svc.cluster.local"
          - name: DB_HOST_WRITE
            value: "sql-mariadb-primary.default.svc.cluster.local"
          - name: DB_PORT
            value: "3306"
          - name: DB_DATABASE
            value: "apidb"
          - name: DB_USERNAME
            value: "apiuser"
          - name: DB_PASSWORD
            valueFrom:
              secretKeyRef:
                name: "sql-secrets-init-passwords"
                key: "SQL_INIT_PASSWORD_API"
